# СПП Мониторинг Бот

Система для отслеживания изменений СПП (Совместных инвестиций) на маркетплейсах Ozon и Wildberries через Telegram бот.

## 🎯 Основные функции

- **Сбор цен через парсер API** — автоматический сбор цен с маркетплейсов
- **Сравнение с прошлым периодом** — анализ изменений СПП
- **Отчеты в Telegram** — ежедневные сводки с кнопками для подробных отчетов
- **Загрузка товаров через Excel** — удобный импорт списков товаров
- **Мультиклиентская поддержка** — работа с несколькими клиентами одновременно

## 📊 Формат отчетов

### Ежедневная сводка
```
📊 СПП Мониторинг: SEB
📅 15.01.2025

🔻 5 товаров снизили СПП
🔺 3 товара повысили СПП
➖ 12 товаров без изменений

📈 Всего отслеживается: 22 товара

Нажмите кнопку ниже для подробного отчета
```

### Подробный Excel отчет
| Артикул | Название | Цена на витрине | Цена из маркетплейса | % скидки |
|---------|----------|-----------------|---------------------|----------|
| 1101001001 | Футболка мужская | 899 | 1299 | 30.8 |
| 1101001020 | Джинсы классические | 1499 | 1999 | 25.0 |

## 🏗 Архитектура

```
┌───────────────┐    ┌───────────────┐    ┌───────────────┐
│ Telegram Bot  │    │ Celery Beat   │    │ Celery Worker │
│  (aiogram 3)  │    │ (Scheduler)   │    │ (Tasks, v2)   │
└───────────────┘    └───────────────┘    └───────────────┘
        │                    │                    │
        ▼                    ▼                    ▼
┌─────────────────┐    ┌────────────┐    ┌─────────────────┐
│   PostgreSQL    │    │   Redis    │    │  Parser API     │
│ (SQLAlchemy v2) │    │ (Broker)   │    │  (Market Data)  │
└─────────────────┘    └────────────┘    └─────────────────┘
```

- Все задачи и логика реализованы в `tasks/app_v2.py` и `services/parser_service_v2.py`.
- Отчеты отправляются **только после появления новых данных от парсера** (записи showcase_price в БД).
- Регулярная проверка готовности отчетов — каждые 3 минуты (Celery Beat).

## 🚀 Быстрый старт

### 1. Настройка окружения

```bash
# Клонируем репозиторий
git clone <repository>
cd pricebot

# Копируем пример конфигурации
cp env.example .env

# Редактируем переменные окружения
nano .env
```

### 2. Переменные окружения (.env)

```env
# Telegram Bot
BOT_TOKEN=your_telegram_bot_token
BOT_USERNAME=your_bot_username

# База данных
DATABASE_URL=postgresql+asyncpg://pricebot:password@db:5432/pricebot

# Redis
CELERY_BROKER=redis://redis:6379/0
CELERY_BACKEND=redis://redis:6379/0

# Парсер API (настраивается для каждого клиента)
PARSER_API_KEY=your_parser_api_key
```

### 3. Запуск через Docker

```bash
# Создаем и запускаем контейнеры
docker-compose up -d

# Проверяем статус
docker-compose ps

# Смотрим логи
docker-compose logs -f bot
```

### 4. Настройка клиентов и аккаунтов

Через Telegram бот:

1. `/add_client` — добавление клиента
2. `/add_account` — добавление аккаунта маркетплейса
3. `/get_template` — получение шаблона Excel
4. Загрузить Excel с товарами

## 📋 Команды бота

### Основные команды
- `/start` — приветствие и список команд
- `/add_client` — мастер добавления клиента
- `/add_account` — мастер добавления аккаунта
- `/get_template` — получение шаблона Excel для товаров
- `/collect_now` — запуск сбора цен прямо сейчас

### Управление товарами
- Отправьте Excel файл с товарами для импорта
- Формат: `client_id | market | account_id | product_code | product_name | product_link`

### Отчеты
- `/snapshot YYYY-MM-DD` — генерация отчета за дату
- Ежедневные сводки отправляются автоматически **после появления новых данных**

## ⏰ Расписание задач

- **Каждые 3 минуты** — Проверка готовности отчетов от парсера (Celery Beat)
- **Отправка отчетов** — Сразу после записи showcase_price в БД (по факту появления новых данных)

## 🗄 Структура базы данных

### Основные таблицы
- `clients` — клиенты системы
- `accounts` — аккаунты маркетплейсов
- `products` — товары для мониторинга
- `orders` — заказы на сбор данных (task_id, статус, ссылка на отчет)
- `results` — результаты по товарам (цены, скидки, showcase_price)

### Ключевые поля
- `parser_api_key` — ключ для работы с парсером
- `discount_percent` — процент скидки СПП
- `group_chat_id` — ID чата для уведомлений

## 🔧 Разработка

### Структура проекта
```
pricebot/
├── bot/                 # Telegram бот
│   └── main.py         # Основной файл бота
├── db/                 # База данных
│   ├── models.py       # SQLAlchemy модели
│   └── session.py      # Настройки сессий
├── services/           # Бизнес-логика
│   ├── parser_service_v2.py # Работа с парсером
│   ├── excel_loader.py      # Импорт товаров
│   └── reporters/          # Генерация отчетов
├── tasks/              # Celery задачи
│   └── app_v2.py       # Все задачи (актуальная версия)
└── docker-compose.yml  # Docker конфигурация
```

### Локальная разработка

```bash
# Установка зависимостей
pip install -r requirements.txt

# Запуск базы данных
docker-compose up db redis -d

# Запуск бота
python -m bot.main

# Запуск Celery worker
celery -A tasks.app_v2 worker --loglevel=info

# Запуск Celery beat
celery -A tasks.app_v2 beat --loglevel=info
```

## 📝 Миграции

```bash
# Применение миграций
docker-compose exec db psql -U pricebot -d pricebot -f /app/migration_add_orders_results.sql
```

## 🐛 Отладка

### Логи
```bash
# Логи бота
docker-compose logs -f bot

# Логи Celery
docker-compose logs -f worker

# Логи базы данных
docker-compose logs -f db
```

### Тестирование
```bash
# Запуск тестов
python test_basic.py
```

## 🧹 Очистка служебных файлов

Для освобождения места можно безопасно удалить все папки `__pycache__`:
```bash
find . -name "__pycache__" -type d -exec rm -r {} +
```

## 📞 Поддержка

При возникновении проблем:

1. Проверьте логи контейнеров
2. Убедитесь в правильности настроек API ключей
3. Проверьте подключение к базе данных
4. Обратитесь к документации парсера API

## 🔄 Обновления

Для обновления системы:

```bash
# Остановка контейнеров
docker-compose down

# Обновление кода
git pull

# Пересборка и запуск
docker-compose up -d --build
```

## 📄 Лицензия

Проект разработан для внутреннего использования. 