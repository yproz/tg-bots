# –ù–∞—Å—Ç—Ä–æ–π–∫–∞ CI/CD Pipeline

## üöÄ –û–±–∑–æ—Ä Pipeline

Pipeline —Å–æ—Å—Ç–æ–∏—Ç –∏–∑ 4 —Å—Ç–∞–¥–∏–π:
1. **lint** - –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–∞—á–µ—Å—Ç–≤–∞ –∫–æ–¥–∞
2. **test** - –ó–∞–ø—É—Å–∫ —Ç–µ—Å—Ç–æ–≤
3. **build** - –°–±–æ—Ä–∫–∞ Docker –æ–±—Ä–∞–∑–∞
4. **deploy** - –î–µ–ø–ª–æ–π –Ω–∞ —Å–µ—Ä–≤–µ—Ä–∞

## üìã –°—Ç–∞–¥–∏–∏ Pipeline

### 1. Lint Stage
- **flake8**: –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∏–ª—è Python –∫–æ–¥–∞
- **black**: –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏—è  
- **isort**: –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∏ –∏–º–ø–æ—Ä—Ç–æ–≤
- **mypy**: –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ç–∏–ø–æ–≤ (allow_failure)

### 2. Test Stage
- **unit tests**: –ó–∞–ø—É—Å–∫ pytest —Å coverage
- **services**: PostgreSQL + Redis –¥–ª—è —Ç–µ—Å—Ç–æ–≤
- **artifacts**: Coverage report –≤ XML

### 3. Build Stage
- **Docker**: –°–±–æ—Ä–∫–∞ –æ–±—Ä–∞–∑–∞ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
- **Registry**: –û—Ç–ø—Ä–∞–≤–∫–∞ –≤ GitLab Container Registry
- **Tags**: `$CI_COMMIT_SHA` + `latest`

### 4. Deploy Stage
- **production**: –ê–≤—Ç–æ–¥–µ–ø–ª–æ–π –≤–µ—Ç–∫–∏ `main` (manual)

## üîß –ù–∞—Å—Ç—Ä–æ–π–∫–∞ GitLab Variables

### –û–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –¥–ª—è CI/CD

–ü–µ—Ä–µ–π–¥–∏—Ç–µ –≤ **Settings ‚Üí CI/CD ‚Üí Variables** –∏ –¥–æ–±–∞–≤—å—Ç–µ:

#### –î–µ–ø–ª–æ–π –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ (Protected ‚úì)
| –ü–µ—Ä–µ–º–µ–Ω–Ω–∞—è | –û–ø–∏—Å–∞–Ω–∏–µ | –ü—Ä–∏–º–µ—Ä |
|------------|----------|--------|
| `SSH_PRIVATE_KEY` | SSH –∫–ª—é—á –¥–ª—è –¥–µ–ø–ª–æ—è | `-----BEGIN OPENSSH PRIVATE KEY-----` |
| `DEPLOY_HOST` | IP/–¥–æ–º–µ–Ω —Å–µ—Ä–≤–µ—Ä–∞ | `89.169.152.79` |
| `DEPLOY_USER` | –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ | `price-robot-vm` |
| `DEPLOY_PATH` | –ü—É—Ç—å –∫ –ø—Ä–æ–µ–∫—Ç—É –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ | `/home/price-robot-vm/pricebot` |

#### –°–µ–∫—Ä–µ—Ç—ã –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è (Protected ‚úì, Masked ‚úì)
–°–º. —Ñ–∞–π–ª `docs/GITLAB_SECRETS_SETUP.md` –¥–ª—è –ø–æ–ª–Ω–æ–≥–æ —Å–ø–∏—Å–∫–∞.

## üîÄ –ü—Ä–∞–≤–∏–ª–∞ –∑–∞–ø—É—Å–∫–∞

### Lint + Test + Build
–ó–∞–ø—É—Å–∫–∞—é—Ç—Å—è –ø—Ä–∏:
- Merge Request –≤ –ª—é–±—É—é –≤–µ—Ç–∫—É
- Push –≤ –≤–µ—Ç–∫–∏ `main`, `dev`

### Deploy
- **production**: Manual –¥–ª—è –≤–µ—Ç–∫–∏ `main`

## üêõ –†–µ—à–µ–Ω–∏–µ –ø—Ä–æ–±–ª–µ–º

### –û—à–∏–±–∫–∏ Lint
```bash
# –õ–æ–∫–∞–ª—å–Ω–æ–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ
pip install -r requirements-dev.txt

# –ê–≤—Ç–æ—Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ
black .
isort .

# –ü—Ä–æ–≤–µ—Ä–∫–∞
flake8 .
mypy bot/ services/ db/ tasks/
```

### –û—à–∏–±–∫–∏ —Ç–µ—Å—Ç–æ–≤
```bash
# –õ–æ–∫–∞–ª—å–Ω—ã–π –∑–∞–ø—É—Å–∫ —Ç–µ—Å—Ç–æ–≤
pytest test_basic.py test_excel_upload.py -v

# –° –ø–æ–∫—Ä—ã—Ç–∏–µ–º
pytest --cov=. --cov-report=html
```

## üîÑ Workflow

### –†–∞–∑—Ä–∞–±–æ—Ç–∫–∞
1. –°–æ–∑–¥–∞–π—Ç–µ feature branch –æ—Ç `dev`
2. –í–Ω–µ—Å–∏—Ç–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è
3. –°–æ–∑–¥–∞–π—Ç–µ MR –≤ `dev`
4. Pipeline –ø—Ä–æ–≤–µ—Ä–∏—Ç –∫–∞—á–µ—Å—Ç–≤–æ –∫–æ–¥–∞
5. –ü–æ—Å–ª–µ approve ‚Üí merge –≤ `dev`

### –†–µ–ª–∏–∑
1. –°–æ–∑–¥–∞–π—Ç–µ MR –∏–∑ `dev` –≤ `main`
2. –ü–æ—Å–ª–µ review ‚Üí merge –≤ `main`
3. Manual deploy –Ω–∞ production
